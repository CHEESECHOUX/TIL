# 성능 최적화

<details>
    <summary><h2>응답 시간과 처리량</h2></summary>
    <strong>네트워크 속도, 디스크 속도, 메모리 크기, 디바이스(스마트폰)의 CPU 속도</strong> 등이 성능과 관련되어 있다.<br>
    <strong>서버 성능과 관련 있는 중요한 지표</strong>를 2가지 꼽자면 <strong>응답 시간과 처리량</strong><br>
    <br>
    <h2>1. 응답 시간</h2>
    <h3>응답 시간 = 사용자의 요청을 처리하는 데 걸리는 시간</h3>
    <p>서버는 로직을 실행한 다음, 응답 데이터를 클라이언트에 전송한다.<br>
    응답 데이터를 전송할 때는 API 요청 과정에서 서버와 연결된 소켓을 이용한다.</p>
    <br>
    <ul>
        <li><strong>TTFB (Time to First Byte):</strong> 응답 데이터 중 <strong>첫 번째 바이트가 도착</strong>할 때까지 걸린 시간</li>
        <li><strong>TTLB (Time to Last Byte):</strong> 응답 데이터의 <strong>마지막 바이트가 도착</strong>할 때 걸린 시간</li>
    </ul>
    <p>응답 데이터의 크기가 작다면 TTFB와 TTLB의 차이가 크지 않다. 하지만 파일 다운로드처럼 전송할 데이터가 크거나 네트워크 속도가 느리면 TTFB와 TTLB의 차이가 커질 수 있다. 
    <strong>데이터 특성이나 네트워크 환경을 고려해 TTFB와 TTLB중 적절한 지표를 선택</strong>해 측정해야 한다.</p> 
    <br>
    <p>응답 시간은 1초보다 짧을 때가 많아, 성능 측정을 위해 1/1000초인 밀리초(ms) 단위를 사용한다.</p>
    <br>
    <h3>응답 시간의 구성</h3>
    <ul>
        <li>API 요청 전송 시간</li>
        <li>서버의 처리 시간</li>
        <li>API 응답 전송 시간</li>
    </ul>
    <p>서버 개발자는 주로 <strong>서버의 처리 시간</strong>을 확인한다.</p>
    <br>
    <h3>서버 처리 시간 구성 요소</h3>
    <ul>
        <li>로직 수행 (if, for 등)</li>
        <li>DB 연동</li>
        <li>외부 API 연동</li>
        <li>응답 데이터 생성 (전송)</li>
    </ul>
    ⭐️ 이 중에서도 <strong>DB 연동</strong>과 <strong>외부 API 연동</strong> 시간이 처리 시간의 대부분을 차지하므로, <strong>응답 시간을 줄이기 위해서는 이 두 부분을 집중적으로 최적화</strong>해야 한다.<br>
    <br><br>
    <h2>2. 처리량</h2>
    <h3>처리량 = 단위 시간당 시스템이 처리하는 작업량</h3>
    <br>
    ⭐️ TPS는 <strong>시스템이 처리할 수 있는 최대 요청 수</strong>를 의미</p>
    <ul>
        <li><strong>TPS (transactions per second):</strong> 초당 트랜잭션 수</li>
        <li><strong>RPS (requests per second):</strong> 초당 요청 수</li>
    </ul>
    <br>
    <p>ex) 서버가 한 번에 5개의 요청을 처리할 수 있다고 가정하면,<br>
    이때 요청당 처리 시간이 1초라면 최대 TPS는 5<br><br>동시에 들어오는 요청 수가 최대 TPS를 초과하면 초과한 요청을 나중에 처리한다.<br>
    <br>
    동시에 7개의 요청이 들어오면 나중에 처리된 2개의 요청 시간은 응답 시간이 2초가 된다.<br>
    (기다리는 시간 1초 + 실제 처리한 시간 1초)</p>
    <br><br>
    <p><strong>요청이 최대 TPS를 초과하면 응답 시간이 지연</strong>된다. 
    응답 시간의 증가는 사용자 이탈로 이어질 수 있다.</p><br>
    <h3>💡 사용자 이탈을 막기 위해 TPS를 높이려면?</h3>
    <ul>
        <li><strong>동시에 처리할 수 있는 요청 수를 늘려</strong> 대기 시간 줄이기</li>
        <li><strong>처리 시간 자체를 줄여</strong> 대기 시간 줄이기</li>
    </ul>
    <br>
    <p><strong>트래픽이 많은 시간대의 TPS와 응답 시간이 얼마인지 측정</strong>하고, 이를 바탕으로 <strong>목표 TPS와 응답 시간을 설정</strong>하고 효과적인 <strong>성능 개선안을 도출</strong>해야 한다.</p>
    <br>
    <p>* TPS를 확인하는 가장 간단한 방법<br>
    모니터링 시스템 (ex: 스카우터, 핀포인트, 뉴렐릭)</p>
    <br>
</details>

<details>
    <summary><h2>병목 지점</h2></summary>
    <h2>병목 지점</h2>
    <p>서비스 초기에는 성능 문제가 발생하지 않는다. <strong>성능 문제는 사용자가 늘면서 점차 나타난다.</strong><br>트래픽이 늘고 데이터가 쌓이면서 간헐적으로 응답 시간이 느려지는 현상이 발생한다.</p>
    <br>
    <strong><h3>✔️ 심각한 성능 문제 예시</h3></strong>
    <ul>
        <li>순간적으로 모든 사용자 요청에 대한 응답 시간이 심각하게 느려진다.<br>10초 이상 걸리는 요청이 늘어나고 다수의 요청에서 연결 시간 초과와 같은 오류가 발생한다.</li>
        <li>서버를 재시작하면 잠시 괜찮다가 다시 응답 시간이 느려지는 현상이 반복된다.</li>
        <li>트래픽이 줄어들 때까지 심각한 상황이 계속된다.</li>
    </ul>
    <br>
    <p>트래픽이 증가하면서 성능 문제가 발생하는 주된 이유는 ⭐️ <strong>시스템이 수용할 수 있는 최대 TPS를 초과하는 트래픽이 유입</strong>되기 때문 이다.<br>
        <strong>TPS를 높이려면 성능 문제가 발생하는 지점을 찾아야 한다.</strong> 문제 지점을 찾는 간단한 방법은 <strong>모니터링 도구를 통해 실제 실행 시간을 측정</strong>해, <strong>처리 시간이 오래 걸리는 작업을 찾는 것</strong>이다.<br>
        <br>
        적절한 <strong>모니터링 도구가 없다면 의심되는 코드의 실행 시간을 로그로 남겨야 한다.</strong> 나중에 성능 문제가 다시 발생했을 때 개선할 부분을 찾는 데 도움이 된다.<br>
        <br>
        <strong>성능 문제는 DB나 외부 API를 연동하는 과정에서 주로 발생</strong>한다.
    </p>
</details>

<details>
    <summary><h2>수직 확장과 수평 확장</h2></summary>
    <h2>수직 확장과 수평 확장</h2>
    <p>사용자가 서비스를 이용하지 못하는 상황에서 이를 방치한 채 시간이 오래 걸리는 개선 방안을 시도할 수 없다.</p>
    <br>
    <p><strong>급하게 해결할 수 있는 방법</strong></p>
    <ul>
        <li><strong>수직 확장</strong>: CPU, 메모리, 디스크 등의 자원을 증가시키는 것</li>
        <li><strong>수평 확장</strong>: 서버 개수를 늘리는 방법<br>
        (서버가 두 대 이상이면 로드 밸런서로 사용자 트래픽을 각 서버에 골고루 분배해줘야 한다.)
        </li>
    </ul>
    <br>
    <p>⭐️ <strong>DB에서 성능 문제가 발생하고 있는데, 서버를 추가로 투입하면 불에 기름을 붓는 격</strong>이다.<br>
    → DB에 문제가 있는 상황에서 DB를 사용하는 서버를 더 늘리면 DB에 가해지는 부하가 더 커짐.</p>
    <p>외부 API 성능이 문제인 경우, 외부 API의 성능이 개선되지 않는 한 서버를 추가한다고 해도 TPS는 향상되지 않는다.</p>
    <br>
    <p><strong>DB나 외부 API에 성능 문제가 발생하지 않는 범위 내에서만 수평 확장</strong>을 해야 효과가 있다.<br>
    (ex: 서버 CPU 사용률이 높을 때, 메모리 부족일 경우, 정적 파일 서빙, 캐시 처리 위주 트래픽 급증일 경우)</p>
    <br><br>
    <p><strong>Q. 수직 확장만 하면 안 되나요?</strong><br>
        수직 확장은 즉각적인 효과를 바로 얻을 수 있지만 트래픽이 지속해서 증가하면 언젠가 또다시 성능 문제가 발생한다.<br>
        <strong>비용이 많이 들기 때문</strong>에, 매번 수직 확장을 반복할 수 없다. 또한 <strong>한 대의 장비가 감당할 수 있는 용량에도 한계</strong>가 있다.<br>
        트래픽이 증가하면 서버를 추가로 투입해 TPS를 높이는 방법(= 수평 확장)도 고려해야 한다.
    </p>

</details>
